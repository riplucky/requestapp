Screen1 As screen:
    OnVisible: =Set(appNumber, Concatenate(Dropdown1.Selected.name,"-",Text(Now(),"yymmddhhmmss")))

    "Gallery6 As gallery.'BrowseLayout_Vertical_TwoTextVariant_ver4.0'":
        Items: =requestapproveemail
        Layout: =Layout.Vertical
        TemplatePadding: =0
        TemplateSize: =Min(104, Self.Height - 60)
        Width: =514
        X: =782
        Y: =44
        ZIndex: =1

        Title10 As label:
            Height: =Self.Size * 1.8
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.email
            VerticalAlign: =VerticalAlign.Top
            Width: =Parent.TemplateWidth - 104
            X: =32
            Y: =16
            ZIndex: =1

        Subtitle5 As label:
            Height: =26
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.requestid
            VerticalAlign: =VerticalAlign.Top
            Width: =84
            X: =32
            Y: =Title10.Y + Title10.Height + 4
            ZIndex: =2

        NextArrow9 As icon.ChevronRight:
            AccessibleLabel: =Self.Tooltip
            Height: =60
            Icon: =Icon.ChevronRight
            OnSelect: =Select(Parent)
            PaddingBottom: =10
            PaddingLeft: =10
            PaddingRight: =10
            PaddingTop: =10
            TabIndex: =0
            Tooltip: ="View item details"
            Width: =60
            X: =Parent.TemplateWidth - Self.Width - 5
            Y: =(Parent.TemplateHeight / 2) - (Self.Height / 2)
            ZIndex: =3

        Separator10 As rectangle:
            Height: =1
            OnSelect: =Select(Parent)
            Width: =Parent.TemplateWidth
            Y: =Parent.TemplateHeight - 1
            ZIndex: =4

        Label9 As label:
            OnSelect: =Select(Parent)
            Text: =ThisItem.stepid
            X: =131
            Y: =52
            ZIndex: =5

    "Gallery4 As gallery.'BrowseLayout_Vertical_TwoTextVariant_ver4.0'":
        Height: =204
        Items: =requestItem
        Layout: =Layout.Vertical
        TemplatePadding: =0
        TemplateSize: =Min(104, Self.Height - 60)
        Width: =595
        X: =84
        Y: =496
        ZIndex: =1

        Title3 As label:
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.appNo
            VerticalAlign: =VerticalAlign.Top
            Width: =330
            X: =32
            Y: =16
            ZIndex: =1

        Subtitle2 As label:
            Height: =26
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.ID
            VerticalAlign: =VerticalAlign.Top
            Width: =301
            X: =32
            Y: =Title3.Y + Title3.Height + 4
            ZIndex: =2

        NextArrow2 As icon.ChevronRight:
            AccessibleLabel: =Self.Tooltip
            Height: =60
            Icon: =Icon.ChevronRight
            OnSelect: =Select(Parent)
            PaddingBottom: =10
            PaddingLeft: =10
            PaddingRight: =10
            PaddingTop: =10
            TabIndex: =0
            Tooltip: ="View item details"
            Width: =60
            X: =Parent.TemplateWidth - Self.Width - 5
            Y: =(Parent.TemplateHeight / 2) - (Self.Height / 2)
            ZIndex: =3

        Separator3 As rectangle:
            Height: =1
            OnSelect: =Select(Parent)
            Width: =Parent.TemplateWidth
            Y: =Parent.TemplateHeight - 1
            ZIndex: =4

        Label3 As label:
            OnSelect: =Select(Parent)
            Text: =ThisItem.name
            Width: =321
            X: =378
            Y: =16
            ZIndex: =5

    Button1 As button:
        OnSelect: |
            =Patch(
                request,
                {
                    appNo: TextInput3.Text,
                    name: TextInput2.Text,
                    typeId: Dropdown1.Selected.ID
                }
            );
            
            // Lấy request mới nhất theo applicaion number (vì application number là duy nhất)
            ClearCollect(
                requestItem,
                Filter(
                    request,
                    appNo = TextInput3.Text
                )
            );
            // Lấy ID của request mới nhất
            Set(requestId, First(requestItem).ID);
            // lấy kiểu typeID theo request đã chọn ban đầu
            Set(
                typeId,
                First(requestItem).typeId
            );
            // lấy approve route theo type
            ClearCollect(
                approveRoute,
                Filter(
                    'request-type',
                    ID = Value(typeId)
                )
            );
            // lấy approve route ID để lấy các step
            Set(
                approveId,
                First(approveRoute).approveRouteId
            );
            // lấy danh sách step approve và sort theo thứ tự tăng dần
            ClearCollect(
                approveStep,
                SortByColumns(
                    Filter(
                        'approve-step',
                        approveRouteId = approveId
                    ),
                    "orderBy",
                    Ascending
                )
            );
            // lấy danh sach email cần approve theo step và input vào bảng request-app-personal. 
            ForAll(
                // lấy từng stepid trong danh sách step
                approveStep As approvestepId,
                ForAll(
                    //lấy email trong approve-person theo stepid
                    Filter(
                        'approve-person',
                        stepid = approvestepId.ID 
                    ),
                    //ghi dữ xuống request-app-personal
                    Patch(
                        'request-app-personal',
                        {
                            requestid: requestId,
                            stepid: stepid,
                            email: email
                        }
                    )
                )
            );
            //ClearCollect(requestapproveemail, Filter('request-app-personal',requestid = requestId));
            
            Reset(Dropdown1);
            Reset(TextInput2);
            Reset(TextInput3);
            Navigate(Screen2);
        Text: ="submit"
        X: =289
        Y: =416
        ZIndex: =2

    Label1 As label:
        Height: =31
        Text: =
        Width: =222
        X: =289
        Y: =194
        ZIndex: =3

    TextInput2 As text:
        Default: =
        OnChange: |-
            =Set(appNumber,
            Concatenate(Dropdown1.Selected.name,"-",Text(Now(),"yymmddhhmmss")))
        X: =289
        Y: =136
        ZIndex: =4

    Dropdown1 As dropdown:
        Items: ='request-type'
        OnChange: =Set(appNumber, Concatenate(Dropdown1.Selected.name,"-",Text(Now(),"yymmddhhmmss")))
        OnSelect: =
        X: =289
        Y: =312
        ZIndex: =5

    TextInput3 As text:
        Default: =appNumber
        X: =289
        Y: =225
        ZIndex: =7

    Button3 As button:
        OnSelect: =Navigate(Screen2);
        Text: ="next"
        X: =541
        Y: =416
        ZIndex: =8

    Button7 As button:
        OnSelect: =Navigate(Screen3)
        Text: ="Back"
        X: =40
        Y: =416
        ZIndex: =9

